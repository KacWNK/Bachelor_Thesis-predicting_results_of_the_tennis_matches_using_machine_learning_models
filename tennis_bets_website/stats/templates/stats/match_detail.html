<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* General Body */
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        /* Top Bar */
        .top-bar {
            background-color: black; /* Black background */
            color: white; /* White text color */
            padding: 0.8rem 1.5rem; /* Padding inside the bar */
            font-size: 1.2rem; /* Text size */
            font-weight: bold; /* Make text bold */
            display: flex; /* Flexbox layout */
            align-items: center; /* Center items vertically */
            justify-content: space-between; /* Space out elements */
            height: 120px;
        }
        .logo-container {
            display: flex; /* Flexbox layout for logo and name */
            align-items: center; /* Center vertically */
            gap: 1rem; /* Space between logo and name */
        }

        /* Site Name */
        .logo-container .site-name {
            font-size: 1.8rem; /* Larger text size for name */
            font-weight: bold; /* Bold font */
            color: white; /* White text color */
        }


        /* Top Bar Buttons */
        .top-bar .nav-buttons a {
            color: white; /* White text */
            text-decoration: none; /* No underline */
            margin-left: 1rem; /* Spacing between buttons */
            padding: 0.5rem 1rem; /* Button padding */
            border-radius: 0.375rem; /* Rounded corners */
            transition: background-color 0.2s; /* Smooth hover effect */
        }

        /* Hover Effect for Buttons */
        .top-bar .nav-buttons a:hover {
            background-color: #444; /* Darker gray on hover */
        }

        /* Main Container */
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 60%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
        }

        /* Match Header */
        .match-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .match-score-container {
            text-align: center; /* Center align both elements */
            margin: 1rem 0; /* Add spacing around the container */
        }

        .match-score {
            font-size: 3rem; /* Adjust font size for the score */
            font-weight: bold; /* Make it bold */
        }

        .match-round {
            font-size: 1rem; /* Smaller font size for the round */
            font-weight: bold; /* Make it bold */
            color: #6c757d; /* Optional: lighter color for round text */
            margin-top: 0.5rem; /* Add spacing between score and round */
        }

        /* Player Section */
        .players-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player {
            text-align: center;
        }

        .player img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            margin-bottom: 0.5rem;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .player-rank {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Match Score */
        .h2h-match-score {
            font-size: 1rem;
            font-weight: bold;
        }

        /* Tabs Styling */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin: 1rem 0;
        }

        .tabs button {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }

        .tabs button.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }

        /* Tab Content */
        .tab-content {
            display: none; /* Hidden by default */
        }

        .tab-content.active {
            display: block; /* Only active tab content is shown */
        }

        /* Score Table */
        .score-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }

        .score-table th,
        .score-table td {
            padding: 0.5rem;
            text-align: center;
        }

        .score-table th {
            background-color: #f1f1f1;
        }

        .score-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .bar-fill.red {
            background-color: #dc3545;
        }

        .bar-fill.blue {
            background-color: #007bff;
        }

        /* Odds */
        .odds-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        /* Footer Info */
        .footer-info {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* Section Headers */
        .section-header {
            font-weight: bold;
            font-size: 1rem;
            text-transform: uppercase;
            padding: 0.5rem 0;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #ddd; /* Divider below header */
            color: #6c757d;
        }

        /* Boxed Sections */
        .section-box {
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }

        /* Stat Rows */
        .stat-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-top-row {
            display: flex; /* Enable flexbox */
            align-items: center; /* Vertically align items */
            margin-bottom: 0.5rem; /* Space below the row */
        }

        /* Stat Title */
        .stat-val-left {
            font-weight: bold;
            font-size: 0.9rem;
            text-align: left;
            margin-right: 1rem; /* Add spacing between label and title */
            white-space: nowrap; /* Prevent text from breaking */
        }

        .stat-val-right {
            font-weight: bold;
            font-size: 0.9rem;
            text-align: right;
            margin-left: 1rem; /* Add spacing between label and title */
            white-space: nowrap; /* Prevent text from breaking */
        }

        .stat-title {
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            flex-grow: 1; /* Take remaining space in the row */
        }

        /* Bar Container */
        .stat-bar-container {
            display: flex;
            align-items: center;
            width: 100%;
            height: 10px; /* Fixed height for bars */
            background-color: #e9ecef; /* Light gray background for the bars */
            border-radius: 4px;
            overflow: hidden; /* Prevent overflow */
        }

        /* Bars */
        .stat-bar-left {
            height: 10px;
            background-color: #1a202c; /* Dark Blue */
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
            direction: ltr; /* Makes the content flow from right to left */
        }

        .stat-bar-right {
            height: 10px;
            background-color: #dc3545; /* Red */
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* Empty Middle Space */
        .stat-bar-empty {
            height: 100%;
            background-color: #e9ecef; /* Gray */
        }


        .bar-fill.red {
            background-color: #dc3545;
        }

        .bar-fill.blue {
            background-color: #007bff;
        }


        .table th {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .stat-header {
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            text-transform: uppercase;
            padding: 0.5rem 0;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #ddd; /* Divider below header */
            color: #6c757d;
        }

        .h2h-filters {
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .result-button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .result-button:hover {
            background-color: #0056b3;
        }
                .filter-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px; /* Rounded buttons */
            background-color: #f1f1f1;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            color: #495057;
        }

        .filter-btn.active {
            background-color: #dc3545; /* Red for active */
            color: white;
        }

        /* General Layout */
        .match-row {
            display: grid;
            grid-template-columns: 1fr 2fr 3fr 2fr 2fr 2fr 2fr; /* Flexible layout for columns */
            align-items: center;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #333; /* Divider */
        }

        .h2h-match-row-text {
            font-size: 0.9rem;
            text-align: center;
            font-weight: bold;
        }


        /* Buttons */
        .match-actions {
            display: flex;
            gap: 0.5rem; /* Spacing between buttons */
            justify-content: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid #007bff; /* Blue border */
            background: transparent;
            color: #007bff;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn:hover {
            background-color: #007bff;
            color: white;
        }

        /* Results Button */
        .btn-results {
            border-color: #007bff;
        }

        .match-row.hidden {
            display: none;
        }

        .stat-row-container.hidden {
            display: none;
        }

        .section-box.hidden {
            display: none;
        }

        /*#points-stats.hidden {*/
        /*    display: none; !* Hide the element when the "hidden" class is added *!*/
        /*}*/

        .h2h-match-table {
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden; /* Rounded corners */
        }

        /* Header Row */
        .h2h-match-header {
            display: grid;
            grid-template-columns: 1fr 2fr 3fr 2fr 2fr 2fr 2fr; /* Column sizes */
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-bottom: 1px solid #333; /* Divider */
        }

        /* Columns in Header */
        .h2h-match-col {
            text-align: center;
        }

        .h2h-header {
            display: flex; /* Align items horizontally */
            justify-content: space-between; /* Push counts to opposite ends */
            margin-bottom: 10px; /* Add spacing below */
            padding: 10px 20px; /* Padding inside the section */
            font-size: 18px; /* Make text larger */
            font-weight: bold; /* Bold font for better emphasis */
            border: 1px solid #ddd; /* Light border for visual separation */
            border-radius: 5px; /* Rounded corners */
            background-color: #f9f9f9; /* Light background color */
        }

    </style>
</head>


<body>
<div class="top-bar">
    <!-- Logo and Name -->
    {% load static %}
    <div class="logo-container">
        <img src="{% static 'tennis-ball.png' %}" width="50" height="50" alt="Logo">
        <span class="site-name">Tennis Insights</span>
    </div>

    <!-- Navigation -->
    <div class="nav-buttons">
        <a href="http://127.0.0.1:8000/stats/results/?date=2025-01-21">Home</a>
    </div>
</div>
<div class="container mt-4">
    <!-- Match Header -->
    <div class="match-header">
        <div class="tournament">              </div>
        <div>            </div>
    </div>

    <!-- Players Section -->
    <div class="players-container">
        <div class="player">
            <!--            <img src="player1.jpg" alt="Player 1">-->
            <div class="player-name">       </div>
            <div class="player-rank">       </div>
        </div>
        <div class="match-score-container">
            <div class="match-score">  -  </div>
            <div class="match-round">     </div>
        </div>
        <div class="player">
            <!--            <img src="player2.jpg" alt="Player 2">-->
            <div class="player-name">       </div>
            <div class="player-rank">       </div>
        </div>
    </div>

    <div class="tabs">
        <button id="summary-tab" class="active">Summary</button>
        <button id="stats-tab">Stats</button>
        <button id="h2h-tab">H2H</button>
        <button id="pre-match-stats-tab">Pre-match Stats</button>

    </div>
    <div id="summary-content" class="tab-content active">
        <!-- Score Section -->
        <div id="score-section" class="section-box">
            <div class="section-header">Score</div>
            <table class="score-table">
                <thead>
                <tr>
                    <th>Player</th>
                    <th>Set 1</th>
                    <th>Set 2</th>
                    <th>Set 3</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Odds Section -->
        <div id='odds-section' class="section-box">
            <div class="section-header">Bookmakers Odds vs Model Predictions</div>
            <table class="score-table">
                <thead>
                <tr>
                    <th>Player</th>
                    <th>Odds</th>
                    <th>Implied Prob. (%)</th>
                    <th>Model Prob. (%)</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Player 1</td>
                    <td>1.82</td>
                    <td>50.41%</td>
                    <td>52.00%</td>
                </tr>
                <tr>
                    <td>Player 2</td>
                    <td>1.85</td>
                    <td>49.59%</td>
                    <td>48.00%</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="stats-content" class="tab-content hidden">
        <div class="h2h-filters" id="stats-filters">
            <!-- Dynamic Filters Will Go Here -->
        </div>
        <div id="service-stats" class="section-box">
            <div class="stat-header">Service</div>
        </div>
        <div id="return-stats" class="section-box">
            <div class="stat-header">Return</div>
        </div>
        <div id="points-stats" class="section-box">
            <div class="stat-header">Points</div>
        </div>
    </div>
    <div id="h2h-content" class="tab-content hidden">
        <div class="h2h-filters" id="surface-filters">
            <!-- Dynamic Surface Filters Will Go Here -->
        </div>

        <div class="section-box">
            <div id="h2h-header" class="h2h-header">
                <div id="player1-wins" class="h2h-wins">Player 1: 0</div>
                <div id="player2-wins" class="h2h-wins">Player 2: 0</div>
            </div>
            <!-- Matches Container -->
            <div class="h2h-match-table" id="match-table">
                <div class="h2h-match-header">
                    <div class="h2h-match-col">Year</div>
                    <div class="h2h-match-col">Winner</div>
                    <div class="h2h-match-col">Event</div>
                    <div class="h2h-match-col">Round</div>
                    <div class="h2h-match-col">Surface</div>
                    <div class="h2h-match-col">Score</div>
                    <div class="h2h-match-col">View Details</div>
                </div>
                <!-- Dynamic Match Rows Will Go Here -->
            </div>
        </div>
    </div>
    <div id="pre-match-stats-content" class="tab-content hidden">
        <div id="current-tournament-record" class="section-box">
            <div class="stat-header">Current tournament</div>
        </div>
        <div id="history-tournament-record" class="section-box">
            <div class="stat-header">History tournament</div>
        </div>
        <div id="ranking-stats" class="section-box">
            <div class="stat-header">Ranking</div>
        </div>
        <div id="recent-form-stats" class="section-box">
            <div class="stat-header">Last 10 Matches Win Percentage</div>
        </div>
        <div id="special-stats" class="section-box">
            <div class="stat-header">Special</div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        await loadMatchData();
    });

    function initializeTabs(scheduled) {
        const tabs = document.querySelectorAll('.tabs button');
        const contents = document.querySelectorAll('.tab-content');
        if (scheduled) removeTabAndContent('stats-tab');
        // if (scheduled) removeTabAndContent('pre-match-stats-tab');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.id.replace('-tab', '-content')).classList.add('active');
            });
        });
    }

    function removeTabAndContent(tabId) {
    // Find the tab button and its associated content
    const tabButton = document.getElementById(tabId);
    const tabContentId = tabId.replace('-tab', '-content');
    const tabContent = document.getElementById(tabContentId);

    // Remove the tab button and content from the DOM
    if (tabButton) tabButton.remove();
    if (tabContent) tabContent.remove();
}

    async function loadMatchData() {
        const matchId = window.location.pathname.replace(/\/$/, '').split('/').pop();

        try {
            const matchData = await fetchJson(`/stats/api/matches/${matchId}/`);
            const scheduled = matchData['scheduled']
            initializeTabs(scheduled);
            const preMatchData = await fetchJson(`/stats/api/pre-match-stats/${matchId}`);
            populateHeader(matchData);
            populateOdds(matchData);
            populatePreMatchStats(preMatchData);

            if (!scheduled) {
            populateScore(matchData);
            populateStats(matchData, preMatchData);
            } else {
                hideSections();
            }

            await loadHeadToHead(matchData);
        } catch (error) {
            console.error('Error fetching match data:', error);
        }
    }

    function hideSections() {
        const scoreSection = document.getElementById('score-section');
        const statsSection = document.getElementById('stats-section');

        // Hide the score section if the API data indicates it should be hidden
        scoreSection.classList.add('hidden');
        statsSection.classList.add('hidden');
    }

    async function loadHeadToHead(data) {
        try {
            const h2h_matches = await fetchJson(`/stats/api/h2h-matches/?player1=${data.winner_id}&player2=${data.loser_id}`);
            processHeadToHead(h2h_matches, data);
        } catch (error) {
            console.error('Error fetching H2H data:', error);
        }
    }

    function processHeadToHead(matches, data) {
        matches = matches.filter(match => {
            const itemDate = new Date(match.date);
            return itemDate < new Date(data.date); // Keep only if the date is earlier than the current date
        });
        const surfaces = ['all', 'hard', 'clay', 'grass'];
        const surfaceWins = initializeSurfaceWins(surfaces, matches, data);
        const matchTable = document.getElementById('match-table');
        console.log(matchTable);
        matches.forEach(match => {
            addMatchRow(matchTable, match);
        });
        updateWinCounts(surfaceWins['all'], data)
        initializeSurfaceFilters(surfaces, surfaceWins, data);
    }

    // Initialize wins by surface
    function initializeSurfaceWins(surfaces, matches, data) {
        const surfaceWins = {};
        surfaces.forEach(surface => {
            surfaceWins[surface] = {p1: 0, p2: 0};
        });
        matches.forEach(match => {
            const surface = match.surface.toLowerCase();
            if (match.winner_name === data.winner_name) {
                surfaceWins[surface].p1++;
                surfaceWins['all'].p1++;
            } else {
                surfaceWins[surface].p2++;
                surfaceWins['all'].p2++;
            }
        })
        return surfaceWins;
    }

    function addMatchRow(table, match) {
        const row = document.createElement('div');
        console.log(match.match_id);
        matchLink = `http://127.0.0.1:8000/stats/match/${match.match_id}`
        row.classList.add('match-row');
        row.setAttribute('data-surface', match.surface.toLowerCase());
        row.innerHTML = `
        <div class="h2h-match-row-text">${match.date.split("-")[0]}</div>
        <div class="h2h-match-row-text">${match.winner_name}</div>
        <div class="h2h-match-row-text">${match.tournament_name}</div>
        <div class="h2h-match-row-text">${match.round}</div>
        <div class="h2h-match-row-text">${match.surface}</div>
        <div class="h2h-match-row-text">${formatScore(match)}</div>
        <div class="h2h-match-row-text">
            <button class="result-button" onclick="window.location.href='${matchLink}'">Results</button>
         </div>
    `;
        table.appendChild(row);
        console.log(row);
    }


    // Filter matches by surface
    function initializeSurfaceFilters(surfaces, surfaceWins, data) {
        console.log("jasd")
        const filtersContainer = document.getElementById('surface-filters');
        const matchRows = document.querySelectorAll('.match-row');

        // Create filter buttons
        surfaces.forEach((surface, index) => {
            const button = document.createElement('button');
            button.classList.add('filter-btn');
            button.textContent = surface.charAt(0).toUpperCase() + surface.slice(1); // Capitalize
            button.setAttribute('data-surface', surface);

            // Mark the first button as active by default
            if (index === 0) button.classList.add('active');
            filtersContainer.appendChild(button);

            // Add click listener
            button.addEventListener('click', () => {
                // Handle active button toggle
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active'); // Mark clicked button as active

                // Filter matches
                matchRows.forEach(row => {
                    const matchSurface = row.getAttribute('data-surface');
                    row.classList.toggle('hidden', surface !== 'all' && matchSurface !== surface);
                });

                // Update win counts
                updateWinCounts(surfaceWins[surface], data)
            });
        });
    }

    // Update win counts
    function updateWinCounts(wins, data) {
        document.getElementById('player1-wins').textContent = `${data.winner_name}: ${wins.p1}`;
        document.getElementById('player2-wins').textContent = `${data.loser_name}: ${wins.p2}`;
    }

    // Function to dynamically extract and format scores
    function formatScore(data) {
        let scores = [];

        // Loop through the keys in the data object
        Object.keys(data).forEach((key) => {
            // Match keys like w1, l1, w2, l2, etc.
            const match = key.match(/([wl])(\d)/); // Matches 'w1', 'l1', etc.
            if (match) {
                const setNumber = match[2]; // Extract set number (1, 2, etc.)
                const type = match[1];     // 'w' or 'l'

                // Initialize array for each set
                if (!scores[setNumber - 1]) {
                    scores[setNumber - 1] = {w: null, l: null};
                }

                scores[setNumber - 1][type] = data[key]; // Assign values
            }
        });

        // Format scores into the desired string
        return scores
            .filter(set => set.w !== null && set.l !== null) // Remove incomplete sets
            .map(set => `${set.w}${set.l}`)                  // Concatenate each set
            .join(" ");                                      // Join all sets with space
    }

    function updateStatBar(section, statName, winnerRaw, loserRaw, isPercent = true, filterType = 'match',
                           winnerValNum = null, loserValNum = null, winnerValDec = null, loserValDec = null) {
        // Calculate stats based on whether they should be treated as percentages
        const winnerStat = isPercent ? (winnerRaw * 100).toFixed(0) : winnerRaw.toFixed(0);
        const loserStat = isPercent ? (loserRaw * 100).toFixed(0) : loserRaw.toFixed(0);
        let winnerPct;
        let loserPct;
        let winnerDisplay, loserDisplay;
         // Handle boolean values
        if (typeof winnerRaw === 'boolean' && typeof loserRaw === 'boolean') {
            winnerDisplay = winnerRaw ? 'Yes' : 'No';
            loserDisplay = loserRaw ? 'Yes' : 'No';
            winnerPct = winnerRaw ? 100 : 0;
            loserPct = loserRaw ? 100 : 0;
        }
        else if (statName.toLowerCase().includes('elo')) {
            const winnerAdj = winnerRaw - 1500;
            const loserAdj = loserRaw - 1500;
            const totalAdj = winnerRaw + loserRaw - 3000;
            if (winnerRaw < 1500) {
                winnerPct = 100;
                loserPct = 0;
            } else if (loserRaw < 1500) {
                winnerPct = 0;
                loserPct = 100;
            } else {
                // Calculate adjusted percentages
                winnerPct = ((winnerAdj / totalAdj) * 100).toFixed(1);
                loserPct = ((loserAdj / totalAdj) * 100).toFixed(1);
            }
            winnerDisplay = winnerRaw.toFixed(0);
            loserDisplay = loserRaw.toFixed(0);
        } else {
            // Calculate percentages for bar widths
            const total = winnerRaw + loserRaw;
            winnerPct = isPercent
                ? winnerStat // Already a percentage
                : (total > 0 ? (winnerRaw / total) * 100 : 0).toFixed(1); // Compute percentage only for non-percent values

            loserPct = isPercent
                ? loserStat // Already a percentage
                : (total > 0 ? (loserRaw / total) * 100 : 0).toFixed(1); // Compute percentage only for non-percent values
                 // Display formats based on whether detailed values are provided
            winnerDisplay = (winnerValNum !== null && winnerValDec !== null)
                ? `${winnerStat}% (${winnerValNum}/${winnerValDec})`
                : isPercent ? `${winnerStat}%` : `${winnerStat}`;

            loserDisplay = (loserValNum !== null && loserValDec !== null)
                ? `${loserStat}% (${loserValNum}/${loserValDec})`
                : isPercent ? `${loserStat}%` : `${loserStat}`;
        }

        const statRow = document.createElement('div');
        statRow.setAttribute('data-filter', filterType);
        statRow.classList.add('stat-row-container');
        statRow.innerHTML = `
            <div class="stat-top-row">
                <div class="stat-val-left">${winnerDisplay}</div>
                <div class="stat-title">${statName}</div>
                <div class="stat-val-right">${loserDisplay}</div>
            </div>
            <div class="stat-row">
                <div class="stat-bar-container">
                    <div class="stat-bar-empty" style="width: ${100 - winnerPct}%;"></div>
                    <div class="stat-bar-left" style="width: ${winnerPct}%;"></div>
                    <div class="stat-bar-right" style="width: ${loserPct}%;"></div>
                    <div class="stat-bar-empty" style="width: ${100 - loserPct}%;"></div>
                </div>
            </div>
    `;
        // Append the generated row to the section
        section.appendChild(statRow);
    }

    async function fetchJson(url) {
        const response = await fetch(url);
        return response.json();
    }

    // Populate match header
    function populateHeader(data) {
        document.querySelector('.tournament').textContent = `${data.tournament_name} (${data.indoor_or_outdoor})`;
        document.querySelector('.match-header div:nth-child(2)').textContent = `${data.date} - ${data.round}`;

        updatePlayerDetails('.player-name', [data.winner_name, data.loser_name]);
        updatePlayerDetails('.player-rank', [`ATP: ${data.winner_rank}`, `ATP: ${data.loser_rank}`]);
    }

    // Update player details
    function updatePlayerDetails(selector, values) {
        document.querySelectorAll(selector).forEach((el, i) => el.textContent = values[i]);
    }

    // Populate match scores
    function populateScore(data) {
        const scoreContainer = document.querySelector('.match-score');
        scoreContainer.textContent = `${data.wsets} - ${data.lsets}`;
    const scoreTable = document.querySelector('.score-table');
    const scoreBody = scoreTable.querySelector('tbody');
    const scoreHead = scoreTable.querySelector('thead');

    const rows = [
        [data.winner_name, ['w1', 'w2', 'w3', 'w4', 'w5']],
        [data.loser_name, ['l1', 'l2', 'l3', 'l4', 'l5']]
    ];

    // Determine which sets have valid data (neither lX nor wX is null)
    const validSetIndices = [];
    for (let i = 1; i <= 5; i++) {
        if (data[`w${i}`] || data[`l${i}`]) {
            validSetIndices.push(i);
        }
    }

    // Dynamically update the table header
    scoreHead.innerHTML = `
        <tr>
            <th>Player</th>
            ${validSetIndices.map(i => `<th>Set ${i}</th>`).join('')}
        </tr>
    `;

    // Populate the table rows
    scoreBody.innerHTML = rows.map(([name, scores]) => `
        <tr>
            <td>${name || '-'}</td>
            ${validSetIndices.map(i => `<td>${data[scores[i - 1]] != null ? data[scores[i - 1]] : ''}</td>`).join('')}
        </tr>
    `).join('');
}


    // Populate odds section
    function populateOdds(data) {
        const oddsTable = document.querySelector('#odds-section table tbody');
        data['loser_odds_prediction'] = 1 - data['winner_odds_prediction']
        data['loser_model_prediction'] = 1 - data['winner_model_prediction']
        oddsTable.innerHTML = ['winner', 'loser']
            .map(type => `
            <tr>
                <td>${data[`${type}_name`]}</td>
                <td>${(data[`avg${type[0]}`] ?? 0).toFixed(2)}</td>
                <td>${(100 * data[`${type}_odds_prediction`]).toFixed(2)}%</td>
                <td>${(100 * data[`${type}_model_prediction`]).toFixed(2)}%</td>
            </tr>`)
            .join('');
    }

    // Populate statistics
    function populateStats(matchData, preMatchData) {
        const serviceStatSection = document.querySelector('#service-stats');
        const returnStatSection = document.querySelector('#return-stats');
        const pointsStatSection = document.querySelector('#points-stats');


        updateStatBar(serviceStatSection, "Aces", matchData.w_ace, matchData.l_ace, false);
        updateStatBar(serviceStatSection, "Aces", preMatchData.w_ace_avg, preMatchData.l_ace_avg, false, 'career');
        updateStatBar(serviceStatSection, "Aces", preMatchData.w_CO_ace_avg, preMatchData.l_CO_ace_avg, false, 'CO');
        updateStatBar(serviceStatSection, "Double Faults", matchData.w_df, matchData.l_df, false) ;
        updateStatBar(serviceStatSection, "Double Faults", preMatchData.w_CO_df_avg, preMatchData.l_CO_df_avg, false, 'CO');
        updateStatBar(serviceStatSection, "Double Faults", preMatchData.w_df_avg, preMatchData.l_df_avg, false, 'career') ;
        updateStatBar(serviceStatSection, "1st Serve In", matchData.winner_1st_serve_in_pct, matchData.loser_1st_serve_in_pct, true, 'match', matchData.w_1stIn, matchData.l_1stIn, matchData.w_svpt, matchData.l_svpt);
        updateStatBar(serviceStatSection, "1st Serve In", preMatchData.winner_1st_serve_in_pct_avg, preMatchData.loser_1st_serve_in_pct_avg, true, 'career');
        updateStatBar(serviceStatSection, "1st Serve In", preMatchData.winner_CO_1st_serve_in_pct_avg, preMatchData.loser_CO_1st_serve_in_pct_avg, true, 'CO');
        updateStatBar(serviceStatSection, "1st Serve Points Won", matchData.winner_1st_serve_win_pct, matchData.loser_1st_serve_win_pct, true, 'match', matchData.w_1stWon, matchData.l_1stWon, matchData.w_1stIn, matchData.l_1stIn);
        updateStatBar(serviceStatSection, "1st Serve Points Won", preMatchData.winner_1st_serve_win_pct_avg, preMatchData.loser_1st_serve_win_pct_avg, true, 'career');
        updateStatBar(serviceStatSection, "1st Serve Points Won", preMatchData.winner_CO_1st_serve_win_pct_avg, preMatchData.loser_CO_1st_serve_win_pct_avg, true, 'CO');
        updateStatBar(serviceStatSection, "2nd Serve Points Won", matchData.winner_2nd_serve_win_pct, matchData.loser_2nd_serve_win_pct, true, 'match', matchData.w_2ndWon, matchData.l_2ndWon, matchData.w_2ndIn, matchData.l_2ndIn);
        updateStatBar(serviceStatSection, "2nd Serve Points Won", preMatchData.winner_2nd_serve_win_pct_avg, preMatchData.loser_2nd_serve_win_pct_avg, true, 'career');
        updateStatBar(serviceStatSection, "2nd Serve Points Won", preMatchData.winner_CO_2nd_serve_win_pct_avg, preMatchData.loser_CO_2nd_serve_win_pct_avg, true, 'CO');
        updateStatBar(serviceStatSection, "Break Points Saved", matchData.winner_bp_saved_pct, matchData.loser_bp_saved_pct, true, 'match', matchData.w_bpSaved, matchData.l_bpSaved, matchData.w_bpFaced, matchData.l_bpFaced);
        updateStatBar(serviceStatSection, "Break Points Saved", preMatchData.winner_bp_saved_pct_avg, preMatchData.loser_bp_saved_pct_avg, true, 'career');
        updateStatBar(serviceStatSection, "Break Points Saved", preMatchData.winner_CO_bp_saved_pct_avg, preMatchData.loser_CO_bp_saved_pct_avg, true, 'CO');
        updateStatBar(serviceStatSection, "Service Games Played", matchData.w_SvGms, matchData.l_SvGms, false);
        updateStatBar(returnStatSection, "1st Serve Return Points Won", matchData.winner_1st_serve_return_win_pct, matchData.loser_1st_serve_return_win_pct, true, 'match', matchData.l_1stIn - matchData.l_1stWon, matchData.w_1stIn - matchData.w_1stWon, matchData.l_1stIn, matchData.w_1stIn);
        updateStatBar(returnStatSection, "1st Serve Return Points Won", preMatchData.winner_1st_serve_return_win_pct_avg, preMatchData.loser_1st_serve_return_win_pct_avg, true, 'career');
        updateStatBar(returnStatSection, "1st Serve Return Points Won", preMatchData.winner_CO_1st_serve_return_win_pct_avg, preMatchData.loser_CO_1st_serve_return_win_pct_avg, true, 'CO');
        updateStatBar(returnStatSection, "2nd Serve Return Points Won", matchData.winner_2nd_serve_return_win_pct, matchData.loser_2nd_serve_return_win_pct, true, 'match', matchData.l_2ndIn - matchData.l_2ndWon, matchData.w_2ndIn - matchData.w_2ndWon, matchData.l_2ndIn, matchData.w_2ndIn);
        updateStatBar(returnStatSection, "2nd Serve Return Points Won", preMatchData.winner_2nd_serve_return_win_pct_avg, preMatchData.loser_2nd_serve_return_win_pct_avg, true, 'career');
        updateStatBar(returnStatSection, "2nd Serve Return Points Won", preMatchData.winner_CO_2nd_serve_return_win_pct_avg, preMatchData.loser_CO_2nd_serve_return_win_pct_avg, true, 'CO');
        updateStatBar(returnStatSection, "Break Points Converted", (matchData.l_bpFaced - matchData.l_bpSaved) / (matchData.l_bpFaced), (matchData.w_bpFaced - matchData.w_bpSaved) / (matchData.w_bpFaced), true, 'match', matchData.l_bpFaced - matchData.l_bpSaved, matchData.w_bpFaced - matchData.w_bpSaved, matchData.l_bpFaced, matchData.w_bpFaced);
        updateStatBar(returnStatSection, "Break Points Converted", preMatchData.winner_bp_won_pct_avg, preMatchData.loser_bp_won_pct_avg, true, 'career');
        updateStatBar(returnStatSection, "Break Points Converted", preMatchData.winner_CO_bp_won_pct_avg, preMatchData.loser_CO_bp_won_pct_avg, true, 'CO');
        updateStatBar(returnStatSection, "Return Games Played", matchData.l_SvGms, matchData.w_SvGms, false);
        updateStatBar(pointsStatSection, "Service Points Won", (matchData.w_1stWon + matchData.w_2ndWon) / matchData.w_svpt, (matchData.l_1stWon + matchData.l_2ndWon) / matchData.l_svpt, true, 'match', matchData.w_1stWon + matchData.w_2ndWon, matchData.l_1stWon + matchData.l_2ndWon, matchData.w_svpt, matchData.l_svpt);
        let w_ReturnWon = matchData.l_1stIn - matchData.l_1stWon + matchData.l_2ndIn - matchData.l_2ndWon
        let w_ReturnPlayed = matchData.l_1stIn + matchData.l_2ndIn
        let l_ReturnWon = matchData.w_1stIn - matchData.w_1stWon + matchData.w_2ndIn - matchData.w_2ndWon
        let l_ReturnPlayed = matchData.w_1stIn + matchData.w_2ndIn
        updateStatBar(pointsStatSection, "Return Points Won", w_ReturnWon / w_ReturnPlayed, l_ReturnWon / l_ReturnPlayed, true, 'match', w_ReturnWon, l_ReturnWon, w_ReturnPlayed, l_ReturnPlayed);
        updateStatBar(pointsStatSection, "Total Points Won", (matchData.w_1stWon + matchData.w_2ndWon + w_ReturnWon) / (matchData.w_svpt + w_ReturnPlayed), (matchData.l_1stWon + matchData.l_2ndWon + l_ReturnWon) / (matchData.l_svpt + l_ReturnPlayed), true, 'match', matchData.w_1stWon + matchData.w_2ndWon + w_ReturnWon, matchData.l_1stWon + matchData.l_2ndWon + l_ReturnWon,  matchData.w_svpt + w_ReturnPlayed, matchData.l_svpt + l_ReturnPlayed);

        initializeStatsFilters()

    }

    function populatePreMatchStats(data) {
        const currentTournamentRecordSection = document.querySelector('#current-tournament-record');
        const historyTournamentRecordSection = document.querySelector('#history-tournament-record');
        const rankingStatSection = document.querySelector('#ranking-stats');
        const recentFormStatSection = document.querySelector('#recent-form-stats');
        const specialStatSection = document.querySelector('#special-stats');


        updateStatBar(currentTournamentRecordSection, "Set Difference", data.Winner_Set_Diff_Tournament, data.Loser_Set_Diff_Tournament, false, 'pre-match');
        updateStatBar(currentTournamentRecordSection, "Game Difference", data.Winner_Game_Diff_Tournament, data.Loser_Game_Diff_Tournament, false, 'pre-match');
        updateStatBar(historyTournamentRecordSection, "Wins", data.winner_total_wins_tournament_history, data.loser_total_wins_tournament_history, false, 'pre-match');
        updateStatBar(historyTournamentRecordSection, "Losses", data.winner_total_losses_tournament_history, data.loser_total_losses_tournament_history, false, 'pre-match');
        updateStatBar(rankingStatSection, "Combined Elo", data.blended_elo_winner, data.blended_elo_loser, false, 'pre-match');
        updateStatBar(rankingStatSection, "Non Surface Elo", data.elo_winner, data.elo_loser, false, 'pre-match');
        updateStatBar(rankingStatSection, "Surface Elo", data.surface_elo_winner, data.surface_elo_loser, false, 'pre-match');
        updateStatBar(recentFormStatSection, "All", data.winner_win_pct_last_10, data.loser_win_pct_last_10, true, 'pre-match');
        updateStatBar(recentFormStatSection, "Surface", data.winner_win_pct_last_10_surface, data.loser_win_pct_last_10_surface, true, 'pre-match');
        updateStatBar(specialStatSection, "Home Advantage", data.winner_home, data.loser_home, true, 'pre-match');
        updateStatBar(specialStatSection, "First Match After Injury", !!data.winner_injury_score, !!data.loser_injury_score, true, 'pre-match');
        updateStatBar(specialStatSection, "Fatigue Score", data.winner_fatigue_score, data.loser_fatigue_score, false, 'pre-match');
    }
function initializeStatsFilters() {
    const filtersContainer = document.getElementById('stats-filters');
    const statRows = document.querySelectorAll('.stat-row-container'); // Select all rows to filter
    const pointsStatsSection = document.getElementById('points-stats'); // Select the points stats section
    statRows.forEach(row => {
        const rowFilter = row.getAttribute('data-filter'); // Get the filter attribute from the row
        row.classList.toggle('hidden', rowFilter !== 'match' && rowFilter !== 'pre-match');
    });
    console.log(statRows);
    const filters = ['match', 'career', 'CO'];
    // Create filter buttons
    filters.forEach((filter, index) => {
        const button = document.createElement('button');
        button.classList.add('filter-btn');
        button.textContent = filter.charAt(0).toUpperCase() + filter.slice(1); // Capitalize
        button.setAttribute('data-filter', filter);

        // Mark the first button as active by default
        if (index === 0) button.classList.add('active');
        filtersContainer.appendChild(button);

        // Add click listener
        button.addEventListener('click', () => {
            // Handle active button toggle
            document.querySelectorAll('#stats-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active'); // Mark clicked button as active
            // Filter rows based on the selected filter
            const selectedFilter = button.getAttribute('data-filter');
            statRows.forEach(row => {
                const rowFilter = row.getAttribute('data-filter'); // Get the filter attribute from the row
                row.classList.toggle('hidden', (rowFilter !== selectedFilter && rowFilter !== 'pre-match'));
            });

            //Hide or show the points stats section based on the filter
            if (selectedFilter === 'career' || selectedFilter === 'CO') {
                pointsStatsSection.classList.add('hidden'); // Hide the points stats section
                updateSpecificStatHeaders(true);
            } else {
                pointsStatsSection.classList.remove('hidden'); // Show the points stats section
                updateSpecificStatHeaders(false);

            }
        });
    });
}
    function updateSpecificStatHeaders(condition) {
    // List of parent IDs to target
    const statSections = ['service-stats', 'return-stats', 'points-stats'];

    // Loop through each section
    statSections.forEach(sectionId => {
        // Get the parent element by ID
        const section = document.getElementById(sectionId);

        if (section) {
            // Find the .stat-header within this section and update it
            const header = section.querySelector('.stat-header');
            if (header) {
                const suffix = ' (AVG/MATCH)';
                const headerText = header.textContent;

                if (condition) {
                    // Add the suffix only if it's not already there
                    if (!headerText.endsWith(suffix)) {
                        header.textContent += suffix;
                    }
                } else {
                    // Remove the suffix if it exists
                    if (headerText.endsWith(suffix)) {
                        header.textContent = headerText.slice(0, -suffix.length);
                    }
                }
            }
        }
    });
}


</script>

</body>
</html>
